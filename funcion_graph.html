<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>–ì—Ä–∞—Ñ–∏–∫–∏ —Ñ—É–Ω–∫—Ü–∏–π</title>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjs@11.8.0/lib/browser/math.min.js"></script>
    <script src="funcion_graph.html"></script>



    <script type="module">
        import { MathfieldElement } from 'https://unpkg.com/mathlive?module';

        window.addEventListener('DOMContentLoaded', () => {
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–∂–∏–º–∞ –∏ —Ñ—É–Ω–∫—Ü–∏–∏
        const lastMode = localStorage.getItem('lastMode') || 'explicit';
        const lastFunction = localStorage.getItem('lastFunction') || '';

        const mathFields = {
        explicit: [{ id: 'zExpr', label: 'z = f(x, y)', value: lastMode === 'explicit' ? lastFunction : 'sin(x) * cos(y)' }],
        implicit: [{ id: 'FExpr', label: 'F(x, y) = 0', value: lastMode === 'implicit' ? lastFunction : 'x^2 + y^2 - 9' }],
        parametric: [
        { id: 'xExpr', label: 'x(t) =', value: lastMode === 'parametric' ? lastFunction.split('|')[0] || 'cos(t)' : 'cos(t)' },
        { id: 'yExpr', label: 'y(t) =', value: lastMode === 'parametric' ? lastFunction.split('|')[1] || 'sin(t)' : 'sin(t)' },
        { id: 'zExpr', label: 'z(t) =', value: lastMode === 'parametric' ? lastFunction.split('|')[2] || 't / 10' : 't / 10' }
        ],
        polar: [
        { id: 'rExpr', label: 'r(theta) =', value: lastMode === 'polar' ? lastFunction : '2 + sin(3 * theta)' }
        ]
        };

        const inputArea = document.getElementById('inputs');
        const selector = document.getElementById('mode');

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        selector.value = lastMode;

        function createField(field) {
        const div = document.createElement('div');
        div.style.marginBottom = '10px';

        const label = document.createElement('label');
        label.innerText = field.label;
        div.appendChild(label);

        const mf = new MathfieldElement();
        mf.id = field.id;
        mf.value = field.value;
        mf.style.marginLeft = "10px";
        mf.style.width = "300px";
        div.appendChild(mf);

        inputArea.appendChild(div);
        }

        function updateFields(type) {
        inputArea.innerHTML = '';
        mathFields[type].forEach(createField);
        }

        function getVal(id) {
        return document.getElementById(id)?.value ?? '';
        }

        selector.addEventListener('change', () => {
        updateFields(selector.value);
        });

        updateFields(selector.value); // initial load

        // –ì–ê–õ–ï–†–ï–Ø –ü–†–ò–ú–ï–†–û–í
        function loadExample(exampleData) {
        const mode = exampleData.mode;
        selector.value = mode;
        updateFields(mode);

        setTimeout(() => {
        if (mode === 'explicit') {
        document.getElementById('zExpr').value = exampleData.expr;
        } else if (mode === 'implicit') {
        document.getElementById('FExpr').value = exampleData.expr;
        } else if (mode === 'parametric') {
        document.getElementById('xExpr').value = exampleData.exprX;
        document.getElementById('yExpr').value = exampleData.exprY;
        document.getElementById('zExpr').value = exampleData.exprZ;
        } else if (mode === 'polar') {
        document.getElementById('rExpr').value = exampleData.expr;
        }
        }, 100);
        }

        // –ü—Ä–∏–º–µ—Ä—ã –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏
        window.examples = {
        explicit: [
        { name: '–í–æ–ª–Ω–∞', expr: 'sin(x) * cos(y)' },
        { name: '–ü–∞—Ä–∞–±–æ–ª–æ–∏–¥', expr: 'x^2 + y^2' },
        { name: '–ì–∏–ø–µ—Ä–±–æ–ª–∏—á–µ—Å–∫–∏–π –ø–∞—Ä–∞–±–æ–ª–æ–∏–¥', expr: 'x^2 - y^2' },
        { name: '–°–µ–¥–ª–æ', expr: 'sin(x) - cos(y)' }
        ],
        implicit: [
        { name: '–û–∫—Ä—É–∂–Ω–æ—Å—Ç—å', expr: 'x^2 + y^2 - 16' },
        { name: '–≠–ª–ª–∏–ø—Å', expr: 'x^2/4 + y^2/9 - 1' },
        { name: '–ì–∏–ø–µ—Ä–±–æ–ª–∞', expr: 'x^2 - y^2 - 4' },
        { name: '–†–æ–∑–∞', expr: 'sin(2*theta) - r' }
        ],
        parametric: [
        { name: '–°–ø–∏—Ä–∞–ª—å', exprX: 'cos(t)', exprY: 'sin(t)', exprZ: 't/5' },
        { name: '–õ–µ–º–Ω–∏—Å–∫–∞—Ç–∞', exprX: 'sin(t)', exprY: 'sin(t)*cos(t)', exprZ: '0' },
        { name: '–í–æ—Å—å–º–µ—Ä–∫–∞', exprX: 'sin(2*t)', exprY: 'sin(t)', exprZ: '0' }
        ],
        polar: [
        { name: '–ö–∞—Ä–¥–∏–æ–∏–¥–∞', expr: '1 + cos(theta)' },
        { name: '–†–æ–∑–∞ (3 –ª–µ–ø–µ—Å—Ç–∫–∞)', expr: 'sin(3*theta)' },
        { name: '–°–ø–∏—Ä–∞–ª—å –ê—Ä—Ö–∏–º–µ–¥–∞', expr: 'theta' }
        ]
        };

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–∞–ª–µ—Ä–µ–∏
        function showExamples() {
        const mode = selector.value;
        const gallery = document.getElementById('examplesGallery');
        gallery.innerHTML = '<h3>–ü—Ä–∏–º–µ—Ä—ã:</h3>';

        window.examples[mode].forEach((example, idx) => {
        const btn = document.createElement('button');
        btn.className = 'example-btn';
        btn.textContent = example.name;
        btn.onclick = () => {
        loadExample({
        mode: mode,
        expr: example.expr,
        exprX: example.exprX,
        exprY: example.exprY,
        exprZ: example.exprZ
        });
        };
        gallery.appendChild(btn);
        });
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞
        showExamples();
        selector.addEventListener('change', showExamples);

        window.plotGraph = function () {
        const mode = selector.value;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ LocalStorage
        let funcToSave = '';
        if (mode === 'explicit') funcToSave = getVal('zExpr');
        else if (mode === 'implicit') funcToSave = getVal('FExpr');
        else if (mode === 'parametric') funcToSave = `${getVal('xExpr')}|${getVal('yExpr')}|${getVal('zExpr')}`;
        else if (mode === 'polar') funcToSave = getVal('rExpr');

        localStorage.setItem('lastFunction', funcToSave);
        localStorage.setItem('lastMode', mode);

        // –ê–ù–ò–ú–ê–¶–ò–Ø –ü–ê–†–ê–ú–ï–¢–†–ê
        const animateParam = document.getElementById('animateParam');
        const paramValue = document.getElementById('paramValue');
        let currentParam = 1;

        if (animateParam && animateParam.checked) {
        currentParam = parseFloat(paramValue.value);
        }

        if (mode === 'explicit') {
        let expr = getVal('zExpr');
        // –ó–∞–º–µ–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä 'a' –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        if (expr.includes('a')) {
        expr = expr.replace(/a/g, currentParam);
        }

        const parsed = math.parse(expr).compile();
        const x = [], y = [], z = [];
        const step = 0.5;

        for (let i = -10; i <= 10; i += step) x.push(i);
        for (let j = -10; j <= 10; j += step) y.push(j);

        for (let i = 0; i < x.length; i++) {
        const row = [];
        for (let j = 0; j < y.length; j++) {
        try {
        const val = parsed.evaluate({ x: x[i], y: y[j] });
        row.push(isFinite(val) ? val : null);
        } catch {
        row.push(null);
        }
        }
        z.push(row);
        }

        Plotly.newPlot('plot', [{
        x: x,
        y: y,
        z: z,
        type: 'surface',
        colorscale: [[0, '#b591d9'], [1, '#b591d9']]
        }], {
        title: `z = ${expr}`,
        scene: { xaxis: { title: 'x' }, yaxis: { title: 'y' }, zaxis: { title: 'z' } },
        margin: { l: 0, r: 0, b: 0, t: 50 },
        });

        } else if (mode === 'implicit') {
        const expr = getVal('FExpr');
        const parsed = math.parse(expr).compile();
        const x = [], y = [], z = [];
        const step = 0.25;

        for (let i = -10; i <= 10; i += step) x.push(i);
        for (let j = -10; j <= 10; j += step) y.push(j);

        for (let i = 0; i < x.length; i++) {
        const row = [];
        for (let j = 0; j < y.length; j++) {
        try {
        row.push(parsed.evaluate({ x: x[i], y: y[j] }));
        } catch {
        row.push(null);
        }
        }
        z.push(row);
        }

        Plotly.newPlot('plot', [{
        type: 'contour',
        x: x,
        y: y,
        z: z,
        contours: { coloring: 'lines', showlabels: true },
        line: { width: 2, color: '#b591d9' },
        showscale: false
        }], {
        title: `F(x, y) = 0: ${expr}`,
        xaxis: { title: 'x' },
        yaxis: { title: 'y' },
        margin: { l: 0, r: 0, b: 0, t: 50 }
        });

        } else if (mode === 'parametric') {
        let xExpr = getVal('xExpr');
        let yExpr = getVal('yExpr');
        let zExpr = getVal('zExpr');

        // –ó–∞–º–µ–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä 'a' –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        if (xExpr.includes('a')) xExpr = xExpr.replace(/a/g, currentParam);
        if (yExpr.includes('a')) yExpr = yExpr.replace(/a/g, currentParam);
        if (zExpr.includes('a')) zExpr = zExpr.replace(/a/g, currentParam);

        const xParsed = math.parse(xExpr).compile();
        const yParsed = math.parse(yExpr).compile();
        const zParsed = math.parse(zExpr).compile();

        const tValues = math.range(0, 10 * Math.PI, 0.1).toArray();
        const x = [], y = [], z = [];

        for (let t of tValues) {
        try {
        x.push(xParsed.evaluate({ t }));
        y.push(yParsed.evaluate({ t }));
        z.push(zParsed.evaluate({ t }));
        } catch {
        x.push(null); y.push(null); z.push(null);
        }
        }

        Plotly.newPlot('plot', [{
        type: 'scatter3d',
        mode: 'lines',
        x: x,
        y: y,
        z: z,
        line: { color: '#f18ba1', width: 4 }
        }], {
        title: '–ü–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∫—Ä–∏–≤–∞—è: x(t), y(t), z(t)',
        scene: { xaxis: { title: 'x' }, yaxis: { title: 'y' }, zaxis: { title: 'z' } },
        margin: { l: 0, r: 0, b: 0, t: 50 }
        });

        } else if (mode === 'polar') {
        let expr = getVal('rExpr');
        // –ó–∞–º–µ–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä 'a' –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        if (expr.includes('a')) {
        expr = expr.replace(/a/g, currentParam);
        }

        const rParsed = math.parse(expr).compile();

        const thetaValues = math.range(0, 2 * Math.PI, 0.01).toArray();
        const x = [], y = [], z = [];

        for (let theta of thetaValues) {
        try {
        const r = rParsed.evaluate({ theta });
        x.push(r * Math.cos(theta));
        y.push(r * Math.sin(theta));
        z.push(theta);
        } catch {
        x.push(null); y.push(null); z.push(null);
        }
        }

        Plotly.newPlot('plot', [{
        type: 'scatter3d',
        mode: 'lines',
        x: x,
        y: y,
        z: z,
        line: { color: '#f18ba1', width: 4 }
        }], {
        title: `–ü–æ–ª—è—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: r(Œ∏) = ${expr}`,
        scene: { xaxis: { title: 'x' }, yaxis: { title: 'y' }, zaxis: { title: 'z' } },
        margin: { l: 0, r: 0, b: 0, t: 50 }
        });
        }
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Ä–∞—â–µ–Ω–∏—è 3D –≥—Ä–∞—Ñ–∏–∫–∞
        window.rotateGraph = function() {
        Plotly.relayout('plot', {
        'scene.camera': {
        eye: {x: 2, y: 2, z: 2}
        }
        });
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        window.downloadImage = function() {
        Plotly.toImage('plot', {format: 'png', width: 800, height: 600})
        .then(function(url) {
        const link = document.createElement('a');
        link.href = url;
        link.download = 'graph.png';
        link.click();
        });
        };
        });
    </script>
</head>


<body>
    <div class="wrapper"></div>
    <nav class="navbar">
        <!-- Navigation bar -->
        <ul>
            <li><a href="home.html">Home</a></li>
            <li><a href="funcion_graph.html">–ì—Ä–∞—Ñ–∏–∫–∏ —Ñ—É–Ω–∫—Ü–∏–π</a></li>
            <li><a href="‚Ññ">–û–±—ä–µ–º—ã –∏ –ø–ª–æ—â–∞–¥–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π</a></li>
            <li><a href="#">–û –Ω–∞—Å</a></li>
        </ul>
    </nav>

    <main>
        <div class="container">
            <h1>–ì—Ä–∞—Ñ–∏–∫–∏ —Ñ—É–Ω–∫—Ü–∏–π</h1>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –≤–≤–µ–¥–∏—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞.</p>

            <!-- Dropdown –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞ -->
            <label for="mode">–¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞:</label>
            <select id="mode" style="margin-bottom: 15px;">
                <option value="explicit">–û–±—ã—á–Ω—ã–π: z = f(x, y)</option>
                <option value="implicit">–ù–µ—è–≤–Ω—ã–π: F(x, y) = 0</option>
                <option value="parametric">–ü–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π: x(t), y(t), z(t)</option>
                <option value="polar">–ü–æ–ª—è—Ä–Ω—ã–π: r(Œ∏)</option>
            </select>

            <!-- –ì–∞–ª–µ—Ä–µ—è –ø—Ä–∏–º–µ—Ä–æ–≤ -->
            <div id="examplesGallery"></div>

            <!-- –ü–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –≤—ã—Ä–∞–∂–µ–Ω–∏–π -->
            <div id="inputs" style="margin-top: 20px;"></div>

            <!-- –ê–Ω–∏–º–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä 'a') -->
            <div id="animationControl" style="margin: 15px 0; display: none;">
                <input type="checkbox" id="animateParam" onchange="toggleAnimation()">
                <label for="animateParam">–ê–Ω–∏–º–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ 'a'</label>
                <input type="range" id="paramValue" min="0.1" max="5" step="0.1" value="1"
                       oninput="document.getElementById('paramDisplay').textContent = this.value; plotGraph()"
                       style="margin-left: 10px;">
                <span id="paramDisplay">1</span>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div style="margin: 20px 0;">
                <button onclick="plotGraph()" style="margin-right: 10px;">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>
                <button onclick="rotateGraph()" style="margin-right: 10px;">‚Üª –í—Ä–∞—â–∞—Ç—å 3D</button>
                <button onclick="downloadImage()" style="margin-right: 10px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å PNG</button>
            </div>

            <!-- –ú–µ—Å—Ç–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ -->
            <div id="plot"></div>
        </div>
    </main>


    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>–û –ø—Ä–æ–µ–∫—Ç–µ</h3>
                <p>–°–∞–π—Ç –±—ã–ª —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –≤ —Ä–∞–º–∫–∞—Ö –∫—É—Ä—Å–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ ¬´–ü—Ä–æ–µ–∫—Ç–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å¬ª. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–ª–∞—Å—å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º HTML, CSS –∏ JavaScript.</p>
                <p>–ü—Ä–æ–µ–∫—Ç –Ω–∞—Ü–µ–ª–µ–Ω –Ω–∞ —É–ª—É—á—à–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –ø—É—Ç—ë–º –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.</p>
            </div>
    </div>
    <div class="footer-bottom">
        <p>¬© 2024 –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
    </div>
    </footer>

    <!-- –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π AI-–ø–æ–º–æ—â–Ω–∏–∫ -->
    <div class="math-ai-widget">
        <button class="math-ai-toggle" onclick="toggleMathAI()">‚à´</button>
        <div class="math-ai-container" id="mathAIContainer">
            <div class="math-ai-header">
                <div>
                    <h3 class="math-ai-title">–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ—à–∞—Ç–µ–ª—å</h3>
                    <div class="math-ai-mode" id="mathMode">–†–µ–∂–∏–º: –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
                </div>
                <button class="close-math-ai" onclick="toggleMathAI()">√ó</button>
            </div>

            <div class="math-ai-messages" id="mathAIMessages">
                <div class="math-message ai-math">
                    <strong>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π AI-–ø–æ–º–æ—â–Ω–∏–∫</strong><br><br>
                    –Ø —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å –Ω–∞:
                    ‚Ä¢ –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ—É–Ω–∫—Ü–∏–π<br>
                    ‚Ä¢ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ—É–Ω–∫—Ü–∏–π<br><br>
                    –í–≤–µ–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—Ä –Ω–∏–∂–µ.
                    –ü—Ä–∏–º–µ—Ä—ã: "d/dx(x^2+2x)" –∏–ª–∏ "‚à´sin(x)dx"
                </div>
            </div>

            <div class="math-tools">
                <button class="math-tool-btn" onclick="setMathMode('derivative')">–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è</button>
                <button class="math-tool-btn" onclick="setMathMode('integral')">–ò–Ω—Ç–µ–≥—Ä–∞–ª</button>
            </div>

            <div class="math-examples">
                <div class="math-examples-title">–ü—Ä–∏–º–µ—Ä—ã –∑–∞–¥–∞—á:</div>
                <div class="math-example" onclick="askMathQuestion('d/dx(x^3 + 2x^2 - x)')">d/dx(x¬≥+2x¬≤-x)</div>
                <div class="math-example" onclick="askMathQuestion('‚à´sin(x)dx')">‚à´sin(x)dx</div>
                <div class="math-example" onclick="askMathQuestion('d/dx(e^x)')">d/dx(eÀ£)</div>
                <div class="math-example" onclick="askMathQuestion('‚à´x^2 dx')">‚à´x¬≤dx</div>
                <div class="math-example" onclick="askMathQuestion('–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è cos(x)')">d/dx(cos(x))</div>
                <div class="math-example" onclick="askMathQuestion('–∏–Ω—Ç–µ–≥—Ä–∞–ª 1/x dx')">‚à´1/x dx</div>
                <div class="math-example" onclick="askMathQuestion('d/dx(sqrt(x))')">d/dx(‚àöx)</div>
                <div class="math-example" onclick="askMathQuestion('‚à´e^x dx')">‚à´eÀ£dx</div>
            </div>

            <div class="math-input-area">
                <input type="text" class="math-input" id="mathInput"
                       placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏—è..."
                       onkeypress="if(event.key === 'Enter') sendMathQuery()">
                <button class="math-send-btn" id="mathSendBtn" onclick="sendMathQuery()">–†–µ—à–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π AI –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
        const mathAI = {
            history: [],
            currentMode: 'derivative',

            // Math.js instance
            math: math,

            // –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ)
            modes: {
                derivative: '–î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ',
                integral: '–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ'
            },

            // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –∑–∞–¥–∞—á–∏
            detectProblemType(query) {
                query = query.toLowerCase();

                if (query.includes('derivative') || query.includes('–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è') || query.includes('d/dx')) {
                    return 'derivative';
                }
                if (query.includes('integral') || query.includes('–∏–Ω—Ç–µ–≥—Ä–∞–ª') || query.includes('‚à´')) {
                    return 'integral';
                }

                return 'derivative'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ
            },

            // –í—ã—á–∏—Å–ª–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é
            calculateDerivative(expr) {
                try {
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ "derivative of" –∏–ª–∏ "d/dx"
                    let expression = expr.replace(/derivative\s+of\s+/i, '')
                        .replace(/d\/dx\(/i, '')
                        .replace(/\)$/, '')
                        .trim();


                    if (!expression) {
                        expression = expr.replace(/–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è\s+/i, '').trim();
                    }

                    // –£–ø—Ä–æ—â–∞–µ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                    expression = expression.replace(/\s+/g, '');

                    let derivative = '';
                    let steps = [`–ò—Å—Ö–æ–¥–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: f(x) = ${expression}`];

                    // –ü—Ä–∞–≤–∏–ª–∞ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏—è
                    if (expression.match(/x\^(\d+)/)) {
                        const match = expression.match(/x\^(\d+)/);
                        const power = parseInt(match[1]);
                        derivative = `${power}*x^${power - 1}`;
                        steps.push(`–ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–æ: d/dx(x‚Åø) = n¬∑x‚Åø‚Åª¬π`);
                        steps.push(`–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è: f'(x) = ${derivative}`);
                    } else if (expression === 'sin(x)' || expression === 'sinx') {
                        derivative = 'cos(x)';
                        steps.push(`d/dx(sin(x)) = cos(x)`);
                    } else if (expression === 'cos(x)' || expression === 'cosx') {
                        derivative = '-sin(x)';
                        steps.push(`d/dx(cos(x)) = -sin(x)`);
                    } else if (expression === 'e^x' || expression === 'exp(x)') {
                        derivative = 'e^x';
                        steps.push(`d/dx(eÀ£) = eÀ£`);
                    } else if (expression === 'ln(x)' || expression === 'log(x)') {
                        derivative = '1/x';
                        steps.push(`d/dx(ln(x)) = 1/x`);
                    } else if (expression === 'tan(x)' || expression === 'tg(x)') {
                        derivative = '1/(cos(x))^2';
                        steps.push(`d/dx(tan(x)) = 1/cos¬≤(x)`);
                    } else if (expression === 'sqrt(x)' || expression === '‚àöx') {
                        derivative = '1/(2*sqrt(x))';
                        steps.push(`d/dx(‚àöx) = 1/(2‚àöx)`);
                    } else if (expression.match(/\d+\*x/)) {
                        const match = expression.match(/(\d+)\*x/);
                        const coef = parseInt(match[1]);
                        derivative = `${coef}`;
                        steps.push(`d/dx(k*x) = k`);
                        steps.push(`–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è: f'(x) = ${derivative}`);
                    } else if (expression === 'x') {
                        derivative = '1';
                        steps.push(`d/dx(x) = 1`);
                    } else if (expression.match(/x\^\d+\+\d+\*x/)) {
                        // –ú–Ω–æ–≥–æ—á–ª–µ–Ω—ã —Ç–∏–ø–∞ x^2+2x
                        const poly = expression;
                        let terms = [];
                        if (poly.includes('+')) {
                            terms = poly.split('+');
                        } else if (poly.includes('-')) {
                            terms = poly.split('-').map((t, i) => i > 0 ? `-${t}` : t);
                        }

                        const derivTerms = terms.map(term => {
                            if (term.match(/x\^(\d+)/)) {
                                const match = term.match(/x\^(\d+)/);
                                const power = parseInt(match[1]);
                                return `${power}*x^${power - 1}`;
                            } else if (term.match(/(\d+)\*x/)) {
                                const match = term.match(/(\d+)\*x/);
                                return match[1];
                            } else if (term === 'x') {
                                return '1';
                            }
                            return term;
                        });


                        derivative = derivTerms.join('+');
                        steps.push(`–î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π —á–ª–µ–Ω:`);
                        terms.forEach((term, i) => {
                            steps.push(`  d/dx(${term}) = ${derivTerms[i]}`);
                        });
                        steps.push(`–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è: f'(x) = ${derivative}`);
                    } else if (expression.match(/sin\(x\)\*cos\(x\)/)) {
                        derivative = 'cos^2(x) - sin^2(x)';
                        steps.push(`d/dx(sin(x)*cos(x)) = cos¬≤(x) - sin¬≤(x)`);
                        steps.push(`–ò–ª–∏: = cos(2x)`);
                    } else if (expression.match(/e\^\(\d+\*x\)/)) {
                        const match = expression.match(/e\^\((\d+)\*x\)/);
                        const k = parseInt(match[1]);
                        derivative = `${k}*e^(${k}*x)`;
                        steps.push(`d/dx(e^(${k}x)) = ${k}*e^(${k}x)`);
                    } else {
                        derivative = `d/dx(${expression})`;
                        steps.push(`–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è: ${derivative}`);
                        steps.push(`(–¥–ª—è —Å–∏–º–≤–æ–ª—å–Ω–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑)`);
                    }

                    return {
                        type: 'derivative',
                        solution: derivative,
                        steps: steps
                    };

                } catch (error) {
                    throw new Error(`–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–æ–π: ${error.message}`);
                }
            },

            // –í—ã—á–∏—Å–ª–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞–ª
            calculateIntegral(expr) {
                try {
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
                    let expression = expr.replace(/integral\s+of\s+/i, '')
                        .replace(/‚à´/g, '')
                        .replace(/dx$/i, '')
                        .trim();

                    if (!expression) {
                        expression = expr.replace(/–∏–Ω—Ç–µ–≥—Ä–∞–ª\s+/i, '').trim();
                    }

                    // –£–ø—Ä–æ—â–∞–µ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
                    expression = expression.replace(/\s+/g, '');

                    let integral = '';
                    let steps = [`–ò–Ω—Ç–µ–≥—Ä–∞–ª: ‚à´${expression} dx`];


                    // –ü—Ä–∞–≤–∏–ª–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
                    if (expression.match(/x\^(\d+)/)) {
                        const match = expression.match(/x\^(\d+)/);
                        const power = parseInt(match[1]);
                        if (power === -1) {
                            integral = `ln|x| + C`;
                            steps.push(`‚à´x‚Åª¬π dx = ln|x| + C`);
                        } else {
                            integral = `x^${power + 1}/${power + 1} + C`;
                            steps.push(`–ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–æ: ‚à´x‚Åø dx = x‚Åø‚Å∫¬π/(n+1) + C`);
                        }
                    } else if (expression === 'sin(x)' || expression === 'sinx') {
                        integral = '-cos(x) + C';
                        steps.push(`‚à´sin(x) dx = -cos(x) + C`);
                    } else if (expression === 'cos(x)' || expression === 'cosx') {
                        integral = 'sin(x) + C';
                        steps.push(`‚à´cos(x) dx = sin(x) + C`);
                    } else if (expression === 'e^x' || expression === 'exp(x)') {
                        integral = 'e^x + C';
                        steps.push(`‚à´eÀ£ dx = eÀ£ + C`);
                    } else if (expression === '1/x') {
                        integral = 'ln|x| + C';
                        steps.push(`‚à´(1/x) dx = ln|x| + C`);
                    } else if (expression === 'sec^2(x)' || expression === '1/(cos(x))^2') {
                        integral = 'tan(x) + C';
                        steps.push(`‚à´sec¬≤(x) dx = tan(x) + C`);
                    } else if (expression === '1/(1+x^2)') {
                        integral = 'arctan(x) + C';
                        steps.push(`‚à´1/(1+x¬≤) dx = arctan(x) + C`);
                    } else if (expression === '1/‚àö(1-x^2)') {
                        integral = 'arcsin(x) + C';
                        steps.push(`‚à´1/‚àö(1-x¬≤) dx = arcsin(x) + C`);
                    } else if (expression.match(/\d+\*x\^\d+/)) {
                        const match = expression.match(/(\d+)\*x\^(\d+)/);
                        const coef = parseInt(match[1]);
                        const power = parseInt(match[2]);
                        integral = `${coef}*x^${power + 1}/${power + 1} + C`;
                        steps.push(`‚à´${coef}*x^${power} dx = ${coef} * ‚à´x^${power} dx`);
                        steps.push(`= ${coef} * x^${power + 1}/${power + 1} + C`);
                    } else if (expression === 'x') {
                        integral = 'x^2/2 + C';
                        steps.push(`‚à´x dx = x¬≤/2 + C`);
                    } else if (expression.match(/\d+\*e\^\(\d+\*x\)/)) {
                        const match = expression.match(/(\d+)\*e\^\((\d+)\*x\)/);
                        const coef = parseInt(match[1]);
                        const k = parseInt(match[2]);
                        integral = `${coef}/${k}*e^(${k}*x) + C`;
                        steps.push(`‚à´${coef}*e^(${k}x) dx = ${coef}/${k}*e^(${k}x) + C`);
                    } else if (expression.match(/sin\(x\)\*cos\(x\)/)) {
                        integral = 'sin^2(x)/2 + C';
                        steps.push(`‚à´sin(x)cos(x) dx = sin¬≤(x)/2 + C`);
                    } else if (expression.match(/x\*e\^x/)) {
                        integral = '(x-1)*e^x + C';
                        steps.push(`‚à´x*eÀ£ dx = (x-1)eÀ£ + C (–∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —á–∞—Å—Ç—è–º)`);
                    } else {
                        integral = `‚à´${expression} dx + C`;
                        steps.push(`–ò–Ω—Ç–µ–≥—Ä–∞–ª: ${integral}`);
                        steps.push(`(–¥–ª—è —Å–∏–º–≤–æ–ª—å–Ω–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑)`);
                    }

                    return {
                        type: 'integral',
                        solution: integral,
                        steps: steps
                    };

                } catch (error) {
                    throw new Error(`–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞–ª–∞: ${error.message}`);
                }
            }
        };


        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        let mathAIContainer, mathAIMessages, mathInput, mathSendBtn, mathModeDisplay;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function () {
            mathAIContainer = document.getElementById('mathAIContainer');
            mathAIMessages = document.getElementById('mathAIMessages');
            mathInput = document.getElementById('mathInput');
            mathSendBtn = document.getElementById('mathSendBtn');
            mathModeDisplay = document.getElementById('mathMode');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ localStorage
            const savedHistory = localStorage.getItem('mathAIHistory');
            if (savedHistory) {
                mathAI.history = JSON.parse(savedHistory);
            }
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —á–∞—Ç
        function toggleMathAI() {
            const isVisible = mathAIContainer.style.display === 'flex';
            mathAIContainer.style.display = isVisible ? 'none' : 'flex';
            if (!isVisible) {
                mathInput.focus();
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∂–∏–º
        function setMathMode(mode) {
            if (!mathAI.modes[mode]) {
                mode = 'derivative'; // –†–µ–∑–µ—Ä–≤–Ω—ã–π —Ä–µ–∂–∏–º
            }

            mathAI.currentMode = mode;
            mathModeDisplay.textContent = `–†–µ–∂–∏–º: ${mathAI.modes[mode]}`;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            const placeholders = {
                derivative: '–í–≤–µ–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: x^2+2x)...',
                integral: '–í–≤–µ–¥–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: x^2)...'
            };

            mathInput.placeholder = placeholders[mode] || placeholders.derivative;
            mathInput.focus();
        }

        // –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–∑ –ø—Ä–∏–º–µ—Ä–∞
        function askMathQuestion(question) {
            mathInput.value = question;
            sendMathQuery();
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å
        async function sendMathQuery() {
            const query = mathInput.value.trim();
            if (!query) return;

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            mathSendBtn.disabled = true;

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            addMathMessage(query, 'user');
            mathAI.history.push({ role: 'user', content: query });

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–∞–¥–∞—á–∏
            const problemType = mathAI.detectProblemType(query);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            showMathTyping();

            try {
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å
                let result;

                switch (problemType) {
                    case 'derivative':
                        result = mathAI.calculateDerivative(query);
                        break;
                    case 'integral':
                        result = mathAI.calculateIntegral(query);
                        break;
                    default:
                        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—ã—Ç–∞–µ–º—Å—è –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞—Ç—å
                        try {
                            result = mathAI.calculateDerivative(query);
                        } catch (e) {
                            // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø—Ä–æ–±—É–µ–º –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å
                            try {
                                result = mathAI.calculateIntegral(query);
                            } catch (e2) {
                                throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –∑–∞–¥–∞—á–∏. –£–∫–∞–∂–∏—Ç–µ —è–≤–Ω–æ "–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è" –∏–ª–∏ "–∏–Ω—Ç–µ–≥—Ä–∞–ª".`);
                            }
                        }
                }

                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                hideMathTyping();

                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                showMathResult(result, problemType);

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                mathAI.history.push({ role: 'assistant', content: result });
                localStorage.setItem('mathAIHistory', JSON.stringify(mathAI.history));


            } catch (error) {
                hideMathTyping();
                showMathError(error.message);
            } finally {
                mathSendBtn.disabled = false;
                mathInput.value = '';
                mathInput.focus();
            }
        }

        // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function addMathMessage(text, type = 'ai') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `math-message ${type === 'user' ? 'user-math' : 'ai-math'}`;

            if (type === 'user') {
                messageDiv.textContent = text;
            } else {
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
                const formattedText = text.replace(/(\w+)\^(\d+)/g, '$1<sup>$2</sup>')
                    .replace(/sqrt\(([^)]+)\)/g, '‚àö$1')
                    .replace(/pi/g, 'œÄ')
                    .replace(/theta/g, 'Œ∏')
                    .replace(/arctan/g, 'arctg')
                    .replace(/arcsin/g, 'arcsin');
                messageDiv.innerHTML = formattedText;
            }

            mathAIMessages.appendChild(messageDiv);
            mathAIMessages.scrollTop = mathAIMessages.scrollHeight;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        function showMathResult(result, problemType) {
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            const typeNames = {
                'derivative': '–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è',
                'integral': '–ò–Ω—Ç–µ–≥—Ä–∞–ª'
            };

            const resultDiv = document.createElement('div');
            resultDiv.className = 'math-result';

            let html = `<strong>${typeNames[result.type] || '–†–µ–∑—É–ª—å—Ç–∞—Ç'}</strong><br><br>`;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —à–∞–≥–∏ —Ä–µ—à–µ–Ω–∏—è
            if (result.steps && result.steps.length > 0) {
                html += '<div class="math-steps">';
                html += '<strong>–®–∞–≥–∏ —Ä–µ—à–µ–Ω–∏—è:</strong><br>';
                result.steps.forEach((step, i) => {
                    const formattedStep = step.replace(/(\w+)\^(\d+)/g, '$1<sup>$2</sup>')
                        .replace(/sqrt\(([^)]+)\)/g, '‚àö$1')
                        .replace(/pi/g, 'œÄ')
                        .replace(/arctan/g, 'arctg')
                        .replace(/arcsin/g, 'arcsin');
                    html += `${i + 1}. ${formattedStep}<br>`;
                });
                html += '</div>';
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ—à–µ–Ω–∏–µ
            html += `<strong>–û—Ç–≤–µ—Ç:</strong><br>`;

            if (Array.isArray(result.solution)) {
                html += result.solution.map(sol =>
                    `<span class="math-expression">${sol}</span>`
                ).join(' –∏–ª–∏ ');
            } else if (typeof result.solution === 'object') {
                html += Object.entries(result.solution)
                    .map(([k, v]) => `${k} = <span class="math-expression">${v}</span>`)
                    .join('<br>');
            } else {
                const formattedSolution = result.solution.toString()
                    .replace(/(\w+)\^(\d+)/g, '$1<sup>$2</sup>')
                    .replace(/sqrt\(([^)]+)\)/g, '‚àö$1')
                    .replace(/pi/g, 'œÄ')
                    .replace(/theta/g, 'Œ∏')
                    .replace(/arctan/g, 'arctg')
                    .replace(/arcsin/g, 'arcsin');
                html += `<span class="math-expression">${formattedSolution}</span>`;
            }

            resultDiv.innerHTML = html;
            mathAIMessages.appendChild(resultDiv);
            mathAIMessages.scrollTop = mathAIMessages.scrollHeight;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showMathError(errorMsg) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'math-error';
            errorDiv.innerHTML = `<strong>–û—à–∏–±–∫–∞:</strong> ${errorMsg}`;
            mathAIMessages.appendChild(errorDiv);
            mathAIMessages.scrollTop = mathAIMessages.scrollHeight;
        }


        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
        function showMathTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-math';
            typingDiv.id = 'mathTypingIndicator';
            typingDiv.innerHTML = `
                    –†–µ—à–∞—é –∑–∞–¥–∞—á—É
                    <div class="typing-math-dots">
                        <div class="typing-math-dot"></div>
                        <div class="typing-math-dot"></div>
                        <div class="typing-math-dot"></div>
                    </div>
                `;
            mathAIMessages.appendChild(typingDiv);
            mathAIMessages.scrollTop = mathAIMessages.scrollHeight;
        }

        // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
        function hideMathTyping() {
            const typing = document.getElementById('mathTypingIndicator');
            if (typing) typing.remove();
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏
        if (window.location.pathname.includes('funcion_graph')) {
            setTimeout(() => {
                if (!localStorage.getItem('mathAIShown')) {
                    toggleMathAI();
                    localStorage.setItem('mathAIShown', 'true');
                }
            }, 2000);
        }
    </script>
</body>
</html>